<?xml version="1.0" encoding="utf-8"?>
<odoo>
  <!-- Portfolio Transaction List View -->
  <record id="view_portfolio_transaction_tree" model="ir.ui.view">
    <field name="name">portfolio.transaction.list</field>
    <field name="model">portfolio.transaction</field>
    <field name="arch" type="xml">
      <list string="Transaction List">
        <field name="name"/>
        <field name="user_id"/>
        <field name="fund_id"/>
        <field name="transaction_type"/>
        <field name="term_months"/>
        <field name="interest_rate"/>
        <field name="units"/>
        <field name="price" widget="monetary"/>
        <field name="amount"/>
        <field name="fee" widget="monetary"/>
        <field name="currency_id"/>
        <field name="status" widget="badge"
               decoration-info="status == 'pending'"
               decoration-success="status == 'completed'"
               decoration-danger="status == 'cancelled'"/>
        <field name="investment_type"/>
        <field name="created_at"/>
        <!-- Add matching fields with visibility conditions -->
        <field name="matched_units" optional="show" 
               invisible="[('transaction_type', 'not in', ['buy', 'sell', 'purchase'])]"/>
        <field name="remaining_units" optional="show"
               invisible="[('transaction_type', 'not in', ['buy', 'sell', 'purchase'])]"/>
        <field name="ccq_remaining_to_match" optional="show"
               invisible="[('transaction_type', 'not in', ['buy', 'sell', 'purchase'])]"/>
        <field name="is_matched" optional="show"
               invisible="[('transaction_type', 'not in', ['buy', 'sell', 'purchase'])]"/>
        <!-- Show matched orders information -->
        <field name="matched_order_ids" optional="show" 
               invisible="[('transaction_type', 'not in', ['buy', 'purchase'])]"
               string="Số lần khớp mua"/>
        <field name="matched_sell_order_ids" optional="show"
               invisible="[('transaction_type', '!=', 'sell')]"
               string="Số lần khớp bán"/>
        <!-- Add match orders button -->
        <button name="action_match_orders" 
                string="Khớp lệnh" 
                type="object" 
                icon="fa-refresh"
                invisible="['|', ('status', '!=', 'completed'), ('transaction_type', 'not in', ['buy', 'sell', 'purchase'])]"
                class="oe_highlight"/>
      </list>
    </field>
  </record>

  <!-- Portfolio Transaction Form View -->
  <record id="view_portfolio_transaction_form" model="ir.ui.view">
    <field name="name">portfolio.transaction.form</field>
    <field name="model">portfolio.transaction</field>
    <field name="arch" type="xml">
      <form string="Transaction">
        <header>
          <field name="status" widget="statusbar"/>
          <!-- Đóng phần còn lại của lệnh khớp một phần -->
          <button name="action_close_partial"
                  string="Đóng phần còn lại"
                  type="object"
                  class="oe_highlight"
                  invisible="['|', ('status','!=','pending'), '|', ('matched_units','&lt;=', 0), ('remaining_units','&lt;=', 0)]"/>
        </header>
        <sheet>
          <group>
            <group>
              <field name="name"/>
              <field name="user_id"/>
              <field name="fund_id"/>
              <field name="transaction_type"/>
              <field name="term_months"/>
              <field name="interest_rate"/>
              <field name="units"/>
              <field name="price" widget="monetary" string="Giá đơn vị"/>
              <field name="amount"/>
              <field name="fee" widget="monetary" string="Phí mua"/>
              <field name="currency_id"/>
            </group>
            <group>
              <field name="status"/>
              <field name="destination_fund_id"/>
              <field name="destination_units"/>
              <field name="investment_type"/>
              <field name="created_at"/>
            </group>
          </group>
          <group>
            <field name="description"/>
            <field name="reference"/>
            <field name="calculated_amount"/>
          </group>
          <group string="Thông tin khớp lệnh" invisible="[('transaction_type', 'not in', ['buy', 'sell', 'purchase'])]">
            <field name="matched_units"/>
            <field name="remaining_units"/>
            <field name="ccq_remaining_to_match"/>
            <field name="is_matched"/>
          </group>
          
          <!-- Thống kê khớp lệnh -->
          <group string="Thống kê khớp lệnh" invisible="[('transaction_type', 'not in', ['buy', 'sell', 'purchase'])]">
            <div class="row">
              <div class="col-6">
                <field name="matched_orders_count" string="Số lần khớp:" widget="badge" decoration-info="matched_orders_count > 0" decoration-success="matched_orders_count > 0"/>
              </div>
              <div class="col-6">
                <field name="matched_units" string="Tổng số lượng đã khớp:" widget="monetary"/>
              </div>
            </div>
          </group>
          
          <!-- Chi tiết lệnh mua đã khớp -->
          <group string="Lệnh mua đã khớp" invisible="[('transaction_type', 'not in', ['buy', 'purchase'])]">
            <field name="matched_order_ids" nolabel="1">
              <list string="Danh sách lệnh bán đã khớp với lệnh mua này" decoration-info="status == 'confirmed'" decoration-success="status == 'completed'">
                <field name="name" string="Mã khớp"/>
                <field name="match_date" string="Ngày khớp"/>
                <field name="matched_quantity" string="Số lượng khớp"/>
                <field name="matched_price" string="Giá khớp"/>
                <field name="total_value" string="Tổng giá trị"/>
                <field name="sell_order_id" string="Lệnh bán đã khớp" widget="many2one"/>
                <field name="status" string="Trạng thái" widget="badge"/>
              </list>
            </field>
          </group>
          
          <!-- Chi tiết lệnh bán đã khớp -->
          <group string="Lệnh bán đã khớp" invisible="[('transaction_type', '!=', 'sell')]">
            <field name="matched_sell_order_ids" nolabel="1">
              <list string="Danh sách lệnh mua đã khớp với lệnh bán này" decoration-info="status == 'confirmed'" decoration-success="status == 'completed'">
                <field name="name" string="Mã khớp"/>
                <field name="match_date" string="Ngày khớp"/>
                <field name="matched_quantity" string="Số lượng khớp"/>
                <field name="matched_price" string="Giá khớp"/>
                <field name="total_value" string="Tổng giá trị"/>
                <field name="buy_order_id" string="Lệnh mua đã khớp" widget="many2one"/>
                <field name="status" string="Trạng thái" widget="badge"/>
              </list>
            </field>
          </group>
        </sheet>
        <div class="oe_chatter">
          <field name="message_follower_ids"/>
          <field name="activity_ids"/>
          <field name="message_ids"/>
        </div>
      </form>
    </field>
  </record>

  <!-- Matched Orders List View -->
  <record id="view_matched_orders_list" model="ir.ui.view">
    <field name="name">transaction.matched.orders.list</field>
    <field name="model">transaction.matched.orders</field>
    <field name="arch" type="xml">
      <list string="Lệnh đã khớp">
        <field name="name" string="Mã khớp"/>
        <field name="match_date" string="Ngày khớp"/>
        <field name="buy_order_id" string="Lệnh mua"/>
        <field name="sell_order_id" string="Lệnh bán"/>
        <field name="matched_quantity" string="Số lượng khớp"/>
        <field name="matched_price" string="Giá khớp"/>
        <field name="total_value" string="Tổng giá trị"/>
        <field name="status" string="Trạng thái"/>
        <field name="match_type" string="Loại khớp"/>
      </list>
    </field>
  </record>

  <!-- Matched Orders Form View -->
  <record id="view_matched_orders_form" model="ir.ui.view">
    <field name="name">transaction.matched.orders.form</field>
    <field name="model">transaction.matched.orders</field>
    <field name="arch" type="xml">
      <form string="Lệnh đã khớp">
        <header>
          <field name="status" widget="statusbar"/>
        </header>
        <sheet>
          <group>
            <group>
              <field name="name"/>
              <field name="match_date"/>
              <field name="status"/>
              <field name="match_type"/>
            </group>
            <group>
              <field name="matched_quantity"/>
              <field name="matched_price"/>
              <field name="total_value"/>
            </group>
          </group>
          <group string="Thông tin lệnh mua">
            <field name="buy_order_id"/>
            <field name="buy_user_id"/>
            <field name="buy_source"/>
            <field name="buy_units"/>
            <field name="buy_remaining_units"/>
          </group>
          <group string="Thông tin lệnh bán">
            <field name="sell_order_id"/>
            <field name="sell_user_id"/>
            <field name="sell_source"/>
            <field name="sell_units"/>
            <field name="sell_remaining_units"/>
          </group>
        </sheet>
        <div class="oe_chatter">
          <field name="message_follower_ids"/>
          <field name="activity_ids"/>
          <field name="message_ids"/>
        </div>
      </form>
    </field>
  </record>

  <!-- Portfolio Transaction Search View -->
  <record id="view_portfolio_transaction_search" model="ir.ui.view">
    <field name="name">portfolio.transaction.search</field>
    <field name="model">portfolio.transaction</field>
    <field name="arch" type="xml">
      <search string="Transaction Search">
        <field name="name"/>
        <field name="user_id"/>
        <field name="fund_id"/>
        <field name="transaction_type"/>
        <field name="price"/>
        <field name="amount"/>
        <field name="status"/>
        <field name="investment_type"/>
        <filter string="Pending" name="pending" domain="[('status', '=', 'pending')]"/>
        <filter string="Completed" name="completed" domain="[('status', '=', 'completed')]"/>
        <filter string="Cancelled" name="cancelled" domain="[('status', '=', 'cancelled')]"/>
        <group expand="0" string="Group By">
          <filter string="Status" name="group_status" context="{'group_by': 'status'}"/>
          <filter string="Fund" name="group_fund" context="{'group_by': 'fund_id'}"/>
          <filter string="Transaction Type" name="group_type" context="{'group_by': 'transaction_type'}"/>
          <filter string="Investment Type" name="group_investment" context="{'group_by': 'investment_type'}"/>
        </group>
      </search>
    </field>
  </record>

  
</odoo> 