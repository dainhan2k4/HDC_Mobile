from odoo import api, fields, models, _
from odoo.exceptions import ValidationError
import json
from datetime import datetime


class Transaction(models.Model):
    _name = "portfolio.transaction"
    _description = "Transaction"
    _inherit = ['portfolio.transaction', 'mail.thread', 'mail.activity.mixin']
    _order = 'create_date desc'

    # Chỉ thêm các field mới hoặc override field từ parent
    # Added fields for NAV Management integration (ensure related fields exist)
    term_months = fields.Integer(string="Kỳ hạn (tháng)", default=12)
    interest_rate = fields.Float(string="Lãi suất (%)", digits=(16, 2))

    # Source field for transaction origin
    source = fields.Selection([
        ('portal', 'Portal'),
        ('sale', 'Sale Portal'),
        ('portfolio', 'Portfolio')
    ], string="Source", default='portfolio', tracking=True)

    # Chỉ thêm các method mới hoặc override method từ parent
    def _update_fund_units(self):
        """Override method từ parent để thêm logic mới"""
        self.ensure_one()
        if self.transaction_type == 'purchase':
            self.fund_id.total_units += self.units
        elif self.transaction_type == 'sell':
            self.fund_id.total_units -= self.units
        elif self.transaction_type == 'exchange':
            self.fund_id.total_units -= self.units
            self.destination_fund_id.total_units += self.destination_units
