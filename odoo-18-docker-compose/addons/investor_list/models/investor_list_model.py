from odoo import models, fields, api, _
from odoo.exceptions import ValidationError
from datetime import datetime

class InvestorList(models.Model):
    _name = 'investor.list'
    _description = 'Danh sách nhà đầu tư'
    _rec_name = 'partner_name'
    _order = 'create_date desc'

    # Thông tin cơ bản từ res.users (portal users)
    user_id = fields.Many2one('res.users', string='User', required=True, ondelete='cascade')
    partner_id = fields.Many2one('res.partner', related='user_id.partner_id', string='Partner', store=True)
    
    # Ngày mở TK - lấy từ thời gian tạo user
    open_date = fields.Datetime(string='Ngày mở TK', related='user_id.create_date', store=True)
    
    # Số tài khoản - lấy từ status_info
    account_number = fields.Char(string='Số tài khoản', compute='_compute_account_number', store=True)
    
    # Thông tin cá nhân - có thể chỉnh sửa nhưng vẫn đồng bộ từ module hồ sơ cá nhân
    partner_name = fields.Char(string='Họ tên', compute='_compute_profile_info', store=True, readonly=False)
    phone = fields.Char(string='Số điện thoại', compute='_compute_profile_info', store=True, readonly=False)
    email = fields.Char(string='Email', compute='_compute_profile_info', store=True, readonly=False)
    id_number = fields.Char(string='ĐKSH', compute='_compute_profile_info', store=True, readonly=False)
    
    # Thông tin địa chỉ - có thể chỉnh sửa nhưng vẫn đồng bộ từ module hồ sơ cá nhân
    province_city = fields.Char(string='Tỉnh/Thành phố', compute='_compute_address_info', store=True, readonly=False)
    
    # Track xem các trường đã được chỉnh sửa thủ công hay chưa
    partner_name_manual = fields.Boolean(string='Họ tên thủ công', default=False)
    phone_manual = fields.Boolean(string='SĐT thủ công', default=False)
    email_manual = fields.Boolean(string='Email thủ công', default=False)
    id_number_manual = fields.Boolean(string='ĐKSH thủ công', default=False)
    province_city_manual = fields.Boolean(string='Tỉnh/TP thủ công', default=False)
    
    # Thông tin bổ sung
    source = fields.Selection([
        ('tpb2', 'TPB2'),
        ('fpla1', 'FPLA1'),
        ('scb', 'SCB'),
        ('other', 'Khác')
    ], string='Nguồn', default='other')
    
    bda_user = fields.Many2one('res.users', string='BDA')
    
    # Trạng thái có thể chỉnh sửa
    status = fields.Selection([
        ('pending', 'Chờ KYC'),
        ('kyc', 'KYC'),
        ('vsd', 'VSD'),
        ('incomplete', 'NĐT chưa cập nhật')
    ], string='Trạng thái', default='incomplete')
    
    # Track xem trạng thái đã được set thủ công hay chưa
    status_manual = fields.Boolean(string='Trạng thái thủ công', default=False)
    
    # Thông tin từ status.info - có thể chỉnh sửa
    trang_thai_tk_dau_tu = fields.Selection([
        ('da_duyet', 'Đã duyệt'),
        ('cho_duyet', 'Chờ duyệt'),
        ('tu_choi', 'Từ chối')
    ], string='Trạng thái TK đầu tư', default='cho_duyet')
    
    ho_so_goc = fields.Selection([
        ('da_nhan', 'Đã nhận'),
        ('chua_nhan', 'Chưa nhận')
    ], string='Hồ sơ gốc', default='chua_nhan')
    
    # Các trường tính toán
    @api.depends('partner_id')
    def _compute_account_number(self):
        for record in self:
            if record.partner_id:
                # Tìm status_info cho partner này
                status_info = self.env['status.info'].search([
                    ('partner_id', '=', record.partner_id.id)
                ], limit=1)
                record.account_number = status_info.so_tk if status_info else ''
            else:
                record.account_number = ''
    
    @api.depends('partner_id')
    def _compute_profile_info(self):
        for record in self:
            if record.partner_id:
                # Tìm investor_profile cho partner này
                profile = self.env['investor.profile'].search([
                    ('partner_id', '=', record.partner_id.id)
                ], limit=1)
                
                if profile:
                    # Chỉ cập nhật nếu chưa được chỉnh sửa thủ công
                    if not record.partner_name_manual:
                        record.partner_name = profile.name or record.partner_id.name
                    if not record.phone_manual:
                        record.phone = profile.phone or record.partner_id.phone
                    if not record.email_manual:
                        record.email = profile.email or record.partner_id.email
                    if not record.id_number_manual:
                        record.id_number = profile.id_number
                else:
                    # Chỉ cập nhật nếu chưa được chỉnh sửa thủ công
                    if not record.partner_name_manual:
                        record.partner_name = record.partner_id.name
                    if not record.phone_manual:
                        record.phone = record.partner_id.phone
                    if not record.email_manual:
                        record.email = record.partner_id.email
                    if not record.id_number_manual:
                        record.id_number = ''
            else:
                # Chỉ cập nhật nếu chưa được chỉnh sửa thủ công
                if not record.partner_name_manual:
                    record.partner_name = ''
                if not record.phone_manual:
                    record.phone = ''
                if not record.email_manual:
                    record.email = ''
                if not record.id_number_manual:
                    record.id_number = ''
    
    @api.depends('partner_id')
    def _compute_address_info(self):
        for record in self:
            if record.partner_id:
                # Tìm investor_address cho partner này
                address = self.env['investor.address'].search([
                    ('partner_id', '=', record.partner_id.id),
                    ('address_type', '=', 'permanent')
                ], limit=1)
                
                if address and address.state_id:
                    # Chỉ cập nhật nếu chưa được chỉnh sửa thủ công
                    if not record.province_city_manual:
                        record.province_city = address.state_id.name
                else:
                    # Chỉ cập nhật nếu chưa được chỉnh sửa thủ công
                    if not record.province_city_manual:
                        record.province_city = ''
            else:
                # Chỉ cập nhật nếu chưa được chỉnh sửa thủ công
                if not record.province_city_manual:
                    record.province_city = ''
    
    @api.onchange('trang_thai_tk_dau_tu', 'ho_so_goc')
    def _onchange_status_info(self):
        """Cập nhật trạng thái khi thay đổi thông tin từ status.info"""
        for record in self:
            # Cập nhật status.info nếu có
            if record.partner_id:
                status_info = self.env['status.info'].search([
                    ('partner_id', '=', record.partner_id.id)
                ], limit=1)
                
                if status_info:
                    status_info.write({
                        'trang_thai_tk_dau_tu': record.trang_thai_tk_dau_tu,
                        'ho_so_goc': record.ho_so_goc
                    })
                
                # Cập nhật trạng thái dựa trên thông tin mới
                self._update_status_from_status_info()
    
    def _update_status_from_status_info(self):
        """Cập nhật trạng thái dựa trên thông tin từ status.info"""
        for record in self:
            # Nếu trạng thái đã được set thủ công, không override
            if record.status_manual:
                continue
                
            # Kiểm tra xem có đủ thông tin cơ bản không
            has_basic_info = (
                record.partner_name and record.partner_name.strip() and
                record.phone and record.phone.strip() and
                record.email and record.email.strip() and
                record.id_number and record.id_number.strip() and
                record.province_city and record.province_city.strip()
            )
            
            if not has_basic_info:
                # NĐT chưa cập nhật: chưa có đủ thông tin cơ bản
                record.status = 'incomplete'
            else:
                # Logic mới dựa trên hồ sơ gốc và trạng thái TK đầu tư
                if record.ho_so_goc == 'chua_nhan' and record.trang_thai_tk_dau_tu == 'cho_duyet':
                    # Nếu hồ sơ gốc và trạng thái đều chưa duyệt thì cập nhật trạng thái NĐT chưa cập nhật
                    record.status = 'incomplete'
                elif record.ho_so_goc == 'da_nhan' and record.trang_thai_tk_dau_tu == 'cho_duyet':
                    # Nếu hồ sơ gốc đã duyệt và trạng thái đang chờ duyệt thì cập nhật trạng thái Chờ KYC
                    record.status = 'pending'
                elif record.ho_so_goc == 'da_nhan' and record.trang_thai_tk_dau_tu == 'da_duyet':
                    # Nếu hồ sơ gốc và trạng thái đều được duyệt thì cập nhật trạng thái KYC
                    record.status = 'kyc'
                elif record.trang_thai_tk_dau_tu == 'tu_choi':
                    # Từ chối: vẫn hiển thị trong danh sách nhưng có thể filter riêng
                    record.status = 'pending'
                else:
                    # Mặc định
                    record.status = 'incomplete'
    
    @api.model
    def create(self, vals):
        # Đảm bảo chỉ tạo cho portal users
        if 'user_id' in vals:
            user = self.env['res.users'].browse(vals['user_id'])
            if user.share != True:  # share=True là portal user
                raise ValidationError(_('Chỉ có thể tạo danh sách cho tài khoản portal.'))
        
        record = super().create(vals)
        
        # Cập nhật trạng thái sau khi tạo
        record._update_status_from_status_info()
        
        return record
    
    def write(self, vals):
        # Track các trường được chỉnh sửa thủ công
        if 'partner_name' in vals:
            vals['partner_name_manual'] = True
        if 'phone' in vals:
            vals['phone_manual'] = True
        if 'email' in vals:
            vals['email_manual'] = True
        if 'id_number' in vals:
            vals['id_number_manual'] = True
        if 'province_city' in vals:
            vals['province_city_manual'] = True
        if 'status' in vals:
            vals['status_manual'] = True
        
        result = super().write(vals)
        
        # Chỉ tự động cập nhật trạng thái nếu chưa được set thủ công
        if ('trang_thai_tk_dau_tu' in vals or 'ho_so_goc' in vals) and not vals.get('status_manual', False):
            self._update_status_from_status_info()
        
        return result
    
    @api.constrains('user_id')
    def _check_user_type(self):
        for record in self:
            if record.user_id and not record.user_id.share:
                raise ValidationError(_('Chỉ có thể thêm tài khoản portal vào danh sách.'))
    
    @api.constrains('user_id')
    def _check_unique_user(self):
        for record in self:
            if record.user_id:
                duplicate = self.search([
                    ('user_id', '=', record.user_id.id),
                    ('id', '!=', record.id)
                ])
                if duplicate:
                    raise ValidationError(_('Tài khoản này đã có trong danh sách.'))
    
    def action_refresh_data(self):
        """Làm mới dữ liệu từ các module khác"""
        for record in self:
            record._compute_account_number()
            record._compute_profile_info()
            record._compute_address_info()
            record._update_status_from_status_info()
        return True
    
    def reset_manual_fields(self):
        """Reset tất cả các trường về tự động (không thủ công)"""
        for record in self:
            record.partner_name_manual = False
            record.phone_manual = False
            record.email_manual = False
            record.id_number_manual = False
            record.province_city_manual = False
            record.status_manual = False
            # Trigger recompute
            record._compute_profile_info()
            record._compute_address_info()
            record._update_status_from_status_info()
        return True
    
    @api.model
    def sync_portal_users(self):
        """Đồng bộ tất cả portal users vào danh sách"""
        portal_users = self.env['res.users'].search([
            ('share', '=', True),
            ('active', '=', True)
        ])
        
        for user in portal_users:
            # Kiểm tra xem đã có trong danh sách chưa
            existing = self.search([('user_id', '=', user.id)], limit=1)
            if not existing:
                self.create({
                    'user_id': user.id,
                })
        
        return {
            'type': 'ir.actions.client',
            'tag': 'display_notification',
            'params': {
                'title': _('Thành công'),
                'message': _('Đã đồng bộ %d tài khoản portal.') % len(portal_users),
                'type': 'success',
                'sticky': False,
            }
        } 