<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <template id="fund_management_control.fund_certificate_form" name="Tạo mới Chứng chỉ quỹ">
        <t t-call="web.layout">
            <t t-set="title">Tạo mới Chứng chỉ quỹ</t>
            <t t-call-assets="web.assets_backend" t-js="true"/>

            <t t-set="head">
                <!-- Dependencies -->
                <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
                <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
                <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet"/>
                
                <style>
                    /* --- General and Layout Styles --- */
                    body {
                        background-color: #f8f9fa;
                        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                        margin: 0;
                        padding: 0;
                    }
                    .app-container {
                        display: flex;
                        min-height: 100vh;
                        position: relative;
                    }
                    .sidebar-container {
                        position: sticky;
                        top: 0;
                        height: 100vh;
                        z-index: 1000;
                    }
                    .sidebar-toggle {
                        position: absolute;
                        top: 15px;
                        right: -15px;
                        background: #fff;
                        border: 2px solid #667eea;
                        border-radius: 50%;
                        width: 30px;
                        height: 30px;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        cursor: pointer;
                        box-shadow: 0 2px 8px rgba(0,0,0,0.15);
                        z-index: 1001;
                        transition: all 0.3s ease;
                    }
                    .sidebar-toggle:hover {
                        background: #667eea;
                        color: #fff !important;
                        transform: scale(1.1);
                    }
                    .main-content {
                        flex: 1;
                        min-height: 100vh;
                        overflow-x: auto;
                    }

                    /* --- Mobile Responsive --- */
                    @media (max-width: 768px) {
                        .sidebar-container {
                            position: fixed;
                            z-index: 1050;
                        }
                        .sidebar-overlay {
                            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                            background: rgba(0,0,0,0.5); z-index: 1040;
                            display: none; opacity: 0; transition: opacity 0.3s ease;
                        }
                        .sidebar-overlay.show { display: block; opacity: 1; }
                        .mobile-header { display: flex !important; }
                        .sidebar-toggle { display: none !important; }
                    }
                    @media (min-width: 769px) {
                        .mobile-header { display: none !important; }
                    }

                    /* --- REFACTOR: Progressive Disclosure and Multi-Step Implementation --- */
                    .form-main-container { 
                        max-width: 900px; 
                        margin: 2rem auto; 
                        padding: 0 1rem; 
                    }
                    
                    /* REFACTOR: Enhanced form card with better visual separation */
                    .form-card { 
                        background: white; 
                        border-radius: 1rem; 
                        box-shadow: 0 8px 25px rgba(0,0,0,0.1); 
                        overflow: hidden; 
                        margin-bottom: 2rem; 
                    }
                    
                    /* REFACTOR: Progressive Disclosure - Step Progress Bar */
                    .step-progress {
                        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                        padding: 1.5rem 2rem;
                        color: white;
                    }
                    
                    .progress-bar-custom {
                        height: 6px;
                        background: rgba(255,255,255,0.2);
                        border-radius: 3px;
                        overflow: hidden;
                        margin-bottom: 1rem;
                    }
                    
                    .progress-fill {
                        height: 100%;
                        background: rgba(255,255,255,0.9);
                        border-radius: 3px;
                        transition: width 0.3s ease;
                        width: 25%; /* Default to step 1 */
                    }
                    
                    .step-nav {
                        display: flex;
                        justify-content: space-between;
                        gap: 1rem;
                        margin-top: 1rem;
                    }
                    
                    .step-nav-item {
                        flex: 1;
                        text-align: center;
                        padding: 0.5rem;
                        border-radius: 0.5rem;
                        background: rgba(255,255,255,0.1);
                        color: rgba(255,255,255,0.7);
                        font-size: 0.875rem;
                        transition: all 0.3s ease;
                    }
                    
                    .step-nav-item.active {
                        background: rgba(255,255,255,0.2);
                        color: white;
                        font-weight: 600;
                    }
                    
                    .step-nav-item.completed {
                        background: rgba(255,255,255,0.15);
                        color: rgba(255,255,255,0.9);
                    }

                    /* REFACTOR: Multi-step form container */
                    .form-steps-container {
                        position: relative;
                        overflow: hidden;
                    }
                    
                    .form-step {
                        display: none;
                        opacity: 0;
                        transform: translateX(30px);
                        transition: all 0.3s ease;
                    }
                    
                    .form-step.active {
                        display: block;
                        opacity: 1;
                        transform: translateX(0);
                    }

                    .card-header-custom { 
                        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
                        color: white; 
                        padding: 2rem; 
                        text-align: center; 
                    }
                    
                    /* REFACTOR: Enhanced form section styling */
                    .form-section { 
                        padding: 2rem; 
                        border-bottom: 1px solid #f0f0f0; 
                    }
                    .form-section:last-child { border-bottom: none; }
                    
                    /* REFACTOR: Improved section header with better visual hierarchy */
                    .section-header { 
                        display: flex; 
                        align-items: center; 
                        margin-bottom: 1.5rem; 
                        color: #2c3e50; 
                    }
                    
                    .section-icon { 
                        width: 45px; 
                        height: 45px; 
                        border-radius: 12px; 
                        background: linear-gradient(135deg, #667eea20 0%, #764ba220 100%); 
                        display: flex; 
                        align-items: center; 
                        justify-content: center; 
                        margin-right: 1rem; 
                    }
                    
                    /* REFACTOR: Enhanced form controls with better touch targets and visual feedback */
                    .form-control, .form-select { 
                        border: 2px solid #e9ecef; 
                        border-radius: 0.75rem; 
                        padding: 1rem 1rem; /* Increased for better touch targets */
                        font-size: 16px; /* Prevent iOS zoom */
                        transition: all 0.3s ease; 
                        min-height: 48px; /* WCAG minimum touch target */
                    }
                    
                    .form-control:focus, .form-select:focus { 
                        border-color: #667eea; 
                        box-shadow: 0 0 0 0.25rem rgba(102, 126, 234, 0.15);
                        outline: 2px solid #0d6efd; /* Better accessibility */
                        outline-offset: 2px;
                    }
                    
                    /* REFACTOR: Enhanced required field visibility */
                    .required-field .form-label::after {
                        content: ' *';
                        color: #dc3545;
                        font-weight: bold;
                        font-size: 1.2em;
                        margin-left: 4px;
                    }
                    
                    .required-field .form-control,
                    .required-field .form-select {
                        border-left: 4px solid #ffc107;
                        padding-left: 1.25rem;
                    }
                    
                    .required-field .form-control:invalid,
                    .required-field .form-select:invalid {
                        border-left-color: #dc3545;
                    }
                    
                    .required-field .form-control:valid,
                    .required-field .form-select:valid {
                        border-left-color: #28a745;
                    }
                    
                    /* REFACTOR: Real-time validation feedback styling */
                    .field-error {
                        color: #dc3545;
                        font-size: 0.875rem;
                        margin-top: 0.25rem;
                        display: flex;
                        align-items: center;
                        gap: 0.25rem;
                    }
                    
                    .field-success {
                        color: #28a745;
                        font-size: 0.875rem;
                        margin-top: 0.25rem;
                        display: flex;
                        align-items: center;
                        gap: 0.25rem;
                    }
                    
                    /* REFACTOR: Improved tooltip contrast for accessibility */
                    .tooltip-icon { 
                        color: #495057; /* Darker gray for better contrast */
                        margin-left: 0.5rem; 
                        cursor: help; 
                        font-size: 1rem;
                    }
                    
                    /* REFACTOR: Enhanced form labels */
                    .form-label {
                        color: #212529; /* High contrast */
                        font-weight: 600; /* Better readability */
                        margin-bottom: 0.75rem;
                    }
                    
                    /* REFACTOR: Improved button styling with loading states */
                    .btn-primary-custom { 
                        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
                        border: none; 
                        border-radius: 0.75rem; 
                        padding: 1rem 2rem; /* Better touch targets */
                        font-weight: 600; 
                        transition: all 0.3s ease; 
                        min-height: 48px;
                        position: relative;
                        overflow: hidden;
                    }
                    
                    .btn-primary-custom:hover { 
                        transform: translateY(-2px); 
                        box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3); 
                    }
                    
                    .btn-primary-custom:disabled {
                        opacity: 0.65;
                        transform: none;
                        cursor: not-allowed;
                    }
                    
                    .btn-secondary-custom { 
                        background: #f8f9fa; 
                        border: 2px solid #dee2e6; 
                        border-radius: 0.75rem; 
                        padding: 1rem 2rem; 
                        font-weight: 600; 
                        color: #495057; 
                        transition: all 0.3s ease; 
                        min-height: 48px;
                    }
                    
                    .btn-secondary-custom:hover { 
                        transform: translateY(-2px); 
                        border-color: #6c757d; 
                        color: #212529; 
                    }
                    
                    /* REFACTOR: Step navigation buttons */
                    .step-navigation {
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        padding: 1.5rem 2rem;
                        background: #f8f9fa;
                        border-top: 1px solid #dee2e6;
                    }
                    
                    .btn-step {
                        padding: 0.75rem 1.5rem;
                        border-radius: 0.5rem;
                        font-weight: 600;
                        transition: all 0.3s ease;
                        min-width: 120px;
                    }
                    
                    .btn-step-prev {
                        background: #6c757d;
                        color: white;
                        border: none;
                    }
                    
                    .btn-step-prev:hover {
                        background: #5a6268;
                        transform: translateY(-1px);
                    }
                    
                    .btn-step-next {
                        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                        color: white;
                        border: none;
                    }
                    
                    .btn-step-next:hover {
                        transform: translateY(-1px);
                        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
                    }
                    
                    /* REFACTOR: Auto-save indicator */
                    .auto-save-status {
                        position: fixed;
                        top: 20px;
                        right: 20px;
                        background: rgba(40, 167, 69, 0.9);
                        color: white;
                        padding: 0.5rem 1rem;
                        border-radius: 0.5rem;
                        font-size: 0.875rem;
                        opacity: 0;
                        transform: translateY(-10px);
                        transition: all 0.3s ease;
                        z-index: 1000;
                    }
                    
                    .auto-save-status.show {
                        opacity: 1;
                        transform: translateY(0);
                    }
                    
                    /* REFACTOR: Responsive optimizations for mobile */
                    @media (max-width: 768px) {
                        .form-control, .form-select {
                            font-size: 16px; /* Prevent zoom on iOS */
                            padding: 1rem;
                        }
                        
                        .btn {
                            min-height: 48px; /* WCAG minimum touch target */
                            padding: 12px 24px;
                        }
                        
                        .step-nav {
                            flex-wrap: wrap;
                            gap: 0.5rem;
                        }
                        
                        .step-nav-item {
                            font-size: 0.75rem;
                            padding: 0.375rem 0.5rem;
                        }
                    }
                </style>
            </t>

            <div class="app-container">
                <!-- Mobile Overlay -->
                <div class="sidebar-overlay" id="sidebarOverlay"></div>
                
                <!-- Mobile Header -->
                <header class="mobile-header w-100 bg-white p-3 shadow-sm align-items-center justify-content-between position-fixed" style="top: 0; left: 0; z-index: 1060;">
                    <h5 class="mb-0 fw-bold">Fund Management</h5>
                    <button class="btn btn-link p-0" id="mobileSidebarToggle">
                        <i class="fas fa-bars fa-lg text-primary"></i>
                    </button>
                </header>

                <!-- Sidebar Container -->
                <div class="sidebar-container" id="sidebarContainer">
                    <div class="sidebar-toggle d-none d-lg-flex" id="sidebarToggle">
                        <i class="fas fa-chevron-left text-primary" id="toggleIcon"></i>
                    </div>
                    <t t-call="fund_management_control.sidebar_template"/>
                </div>

                <!-- Main Content -->
                <main class="main-content">
                    <!-- Mobile content offset -->
                    <div class="d-block d-md-none" style="height: 70px;"></div>

                    <!-- REFACTOR: Auto-save status indicator -->
                    <div class="auto-save-status" id="autoSaveStatus">
                        <i class="fas fa-check-circle me-1"></i>
                        <span id="autoSaveText">Đã lưu tự động</span>
                    </div>

                    <div class="form-main-container">
                        <div class="form-card">
                            <!-- REFACTOR: Progressive Disclosure - Step Progress Header -->
                            <div class="step-progress">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <h2 class="mb-0 h4"><i class="fas fa-file-signature me-2"></i>Tạo mới Chứng chỉ quỹ</h2>
                                    <span class="badge bg-light text-dark px-3 py-2 rounded-pill">
                                        <span id="currentStepText">Bước 1/4</span>
                                    </span>
                                </div>
                                <p class="mb-3 opacity-90">Thiết lập thông tin chi tiết cho một chứng chỉ quỹ mới.</p>
                                
                                <!-- Progress Bar -->
                                <div class="progress-bar-custom">
                                    <div class="progress-fill" id="progressFill"></div>
                                </div>
                                
                                <!-- Step Navigation Pills -->
                                <div class="step-nav">
                                    <div class="step-nav-item active" id="stepNav1">
                                        <i class="fas fa-info-circle me-1"></i>
                                        <span class="d-none d-sm-inline">Thông tin cơ bản</span>
                                        <span class="d-sm-none">Bước 1</span>
                                    </div>
                                    <div class="step-nav-item" id="stepNav2">
                                        <i class="fas fa-calendar-alt me-1"></i>
                                        <span class="d-none d-sm-inline">Thời gian</span>
                                        <span class="d-sm-none">Bước 2</span>
                                    </div>
                                    <div class="step-nav-item" id="stepNav3">
                                        <i class="fas fa-sitemap me-1"></i>
                                        <span class="d-none d-sm-inline">Phân loại</span>
                                        <span class="d-sm-none">Bước 3</span>
                                    </div>
                                    <div class="step-nav-item" id="stepNav4">
                                        <i class="fas fa-puzzle-piece me-1"></i>
                                        <span class="d-none d-sm-inline">Hoàn thiện</span>
                                        <span class="d-sm-none">Bước 4</span>
                                    </div>
                                </div>
                            </div>

                            <form action="/fund_certificate/create" method="POST" enctype="multipart/form-data" id="fundCertificateForm" novalidate="1">
                                <input type="hidden" name="csrf_token" t-att-value="request.csrf_token()"/>
                                
                                <!-- REFACTOR: Multi-step form container with progressive disclosure -->
                                <div class="form-steps-container">
                                    <!-- Step 1: Basic Information -->
                                    <div class="form-step active" id="step1">
                                        <div class="form-section">
                                            <div class="section-header">
                                                <div class="section-icon"><i class="fas fa-info-circle fa-lg text-primary"></i></div>
                                                <div>
                                                    <h5 class="mb-1">Thông tin cơ bản</h5>
                                                    <small class="text-muted">Nhập thông tin tên và mã định danh của quỹ.</small>
                                                </div>
                                            </div>
                                            <div class="row g-4">
                                                <!-- REFACTOR: Enhanced required field styling with better visual hierarchy -->
                                                <div class="col-md-6 required-field">
                                                    <label for="full_name" class="form-label">Tên quỹ đầy đủ
                                                        <i class="fas fa-question-circle tooltip-icon" data-bs-toggle="tooltip" title="Tên chính thức của quỹ, sẽ hiển thị trên tài liệu pháp lý."></i>
                                                    </label>
                                                    <input type="text" class="form-control" id="full_name" name="full_name" 
                                                           placeholder="Ví dụ: Quỹ Đầu tư Cổ phiếu Việt Nam" required="1"/>
                                                    <div class="field-error" id="full_name_error" style="display: none;">
                                                        <i class="fas fa-exclamation-circle"></i>
                                                        <span>Trường này là bắt buộc</span>
                                                    </div>
                                                </div>
                                                
                                                <div class="col-md-6 required-field">
                                                    <label for="english_name" class="form-label">Tên quỹ Tiếng Anh
                                                        <i class="fas fa-question-circle tooltip-icon" data-bs-toggle="tooltip" title="Tên tiếng Anh cho báo cáo và giao dịch quốc tế."></i>
                                                    </label>
                                                    <input type="text" class="form-control" id="english_name" name="english_name" 
                                                           placeholder="Ví dụ: Vietnam Equity Fund" required="1"/>
                                                    <div class="field-error" id="english_name_error" style="display: none;">
                                                        <i class="fas fa-exclamation-circle"></i>
                                                        <span>Trường này là bắt buộc</span>
                                                    </div>
                                                </div>
                                                
                                                <!-- REFACTOR: Responsive field layout for better mobile experience -->
                                                <div class="col-xl-4 col-lg-6 col-md-6 required-field">
                                                    <label for="short_name" class="form-label">Mã quỹ (viết tắt)
                                                        <i class="fas fa-question-circle tooltip-icon" data-bs-toggle="tooltip" title="Mã ngắn gọn để nhận diện quỹ (tối đa 10 ký tự)."></i>
                                                    </label>
                                                    <input type="text" class="form-control" id="short_name" name="short_name" 
                                                           placeholder="Ví dụ: VCBF" required="1" maxlength="10"/>
                                                    <div class="field-error" id="short_name_error" style="display: none;">
                                                        <i class="fas fa-exclamation-circle"></i>
                                                        <span>Trường này là bắt buộc</span>
                                                    </div>
                                                </div>
                                                
                                                <div class="col-xl-4 col-lg-6 col-md-6">
                                                    <label for="fund_color" class="form-label">Màu đại diện
                                                        <i class="fas fa-question-circle tooltip-icon" data-bs-toggle="tooltip" title="Màu này sẽ được sử dụng trong biểu đồ và báo cáo."></i>
                                                    </label>
                                                    <input type="color" class="form-control form-control-color" id="fund_color" name="fund_color" value="#667eea"/>
                                                </div>
                                                
                                                <div class="col-xl-4 col-lg-12 col-md-12 required-field">
                                                    <label for="current_nav" class="form-label">Giá NAV ban đầu
                                                        <i class="fas fa-question-circle tooltip-icon" data-bs-toggle="tooltip" title="Giá trị tài sản ròng trên một chứng chỉ quỹ tại thời điểm phát hành."></i>
                                                    </label>
                                                    <div class="input-group">
                                                        <input type="number" step="0.01" class="form-control" id="current_nav" name="current_nav" 
                                                               placeholder="10000" required="1"/>
                                                        <span class="input-group-text">VND</span>
                                                    </div>
                                                    <div class="field-error" id="current_nav_error" style="display: none;">
                                                        <i class="fas fa-exclamation-circle"></i>
                                                        <span>Trường này là bắt buộc</span>
                                                    </div>
                                                </div>
                                                
                                                <!-- Trường mới cho quỹ đóng -->
                                                <div class="col-xl-6 col-lg-6 col-md-12">
                                                    <label for="initial_certificate_quantity" class="form-label">Số lượng chứng chỉ quỹ đóng ban đầu
                                                        <i class="fas fa-question-circle tooltip-icon" data-bs-toggle="tooltip" title="Tổng số chứng chỉ quỹ được phát hành ban đầu cho quỹ đóng."></i>
                                                    </label>
                                                    <div class="input-group">
                                                        <input type="number" class="form-control" id="initial_certificate_quantity" name="initial_certificate_quantity" 
                                                               placeholder="1000000" value="1000000"/>
                                                        <span class="input-group-text">chứng chỉ</span>
                                                    </div>
                                                </div>
                                                
                                                <div class="col-xl-6 col-lg-6 col-md-12">
                                                    <label for="initial_certificate_price" class="form-label">Giá chứng chỉ quỹ ban đầu
                                                        <i class="fas fa-question-circle tooltip-icon" data-bs-toggle="tooltip" title="Giá phát hành ban đầu của mỗi chứng chỉ quỹ."></i>
                                                    </label>
                                                    <div class="input-group">
                                                        <input type="number" step="0.01" class="form-control" id="initial_certificate_price" name="initial_certificate_price" 
                                                               placeholder="10000" value="10000"/>
                                                        <span class="input-group-text">VND</span>
                                                    </div>
                                                </div>
                                                
                                                <div class="col-xl-6 col-lg-6 col-md-12">
                                                    <label for="capital_cost" class="form-label">Chi phí vốn
                                                        <i class="fas fa-question-circle tooltip-icon" data-bs-toggle="tooltip" title="Tỷ lệ chi phí vốn của quỹ (%)."></i>
                                                    </label>
                                                    <div class="input-group">
                                                        <input type="number" step="0.01" class="form-control" id="capital_cost" name="capital_cost" 
                                                               placeholder="9.00" value="9.00"/>
                                                        <span class="input-group-text">%</span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Step 2: Timing Information -->
                                    <div class="form-step" id="step2">
                                        <div class="form-section">
                                            <div class="section-header">
                                                <div class="section-icon"><i class="fas fa-calendar-alt fa-lg text-info"></i></div>
                                                <div>
                                                    <h5 class="mb-1">Thông tin thời gian</h5>
                                                    <small class="text-muted">Cấu hình lịch giao dịch và các thời hạn quan trọng.</small>
                                                </div>
                                            </div>
                                            <div class="row g-4">
                                                <div class="col-md-6 required-field">
                                                    <label for="inception_date" class="form-label">Thời gian đóng sổ lệnh
                                                        <i class="fas fa-question-circle tooltip-icon" data-bs-toggle="tooltip" title="Thời điểm ngừng nhận lệnh giao dịch trong ngày."></i>
                                                    </label>
                                                    <input type="datetime-local" class="form-control" id="inception_date" name="inception_date" required="1"/>
                                                    <div class="field-error" id="inception_date_error" style="display: none;">
                                                        <i class="fas fa-exclamation-circle"></i>
                                                        <span>Trường này là bắt buộc</span>
                                                    </div>
                                                </div>
                                                
                                                <div class="col-md-6 required-field">
                                                    <label for="closure_date" class="form-label">Ngày đóng sổ lệnh
                                                        <i class="fas fa-question-circle tooltip-icon" data-bs-toggle="tooltip" title="Ngày cuối cùng trong kỳ nhận lệnh đặt mua/bán."></i>
                                                    </label>
                                                    <input type="date" class="form-control" id="closure_date" name="closure_date" required="1"/>
                                                    <div class="field-error" id="closure_date_error" style="display: none;">
                                                        <i class="fas fa-exclamation-circle"></i>
                                                        <span>Trường này là bắt buộc</span>
                                                    </div>
                                                </div>
                                                
                                                <div class="col-md-6 required-field">
                                                    <label for="receive_money_time" class="form-label">Thời điểm ghi nhận tiền
                                                        <i class="fas fa-question-circle tooltip-icon" data-bs-toggle="tooltip" title="Thời điểm chính thức ghi nhận tiền từ nhà đầu tư vào quỹ."></i>
                                                    </label>
                                                    <input type="datetime-local" class="form-control" id="receive_money_time" name="receive_money_time" required="1"/>
                                                    <div class="field-error" id="receive_money_time_error" style="display: none;">
                                                        <i class="fas fa-exclamation-circle"></i>
                                                        <span>Trường này là bắt buộc</span>
                                                    </div>
                                                </div>
                                                
                                                <div class="col-md-6 required-field">
                                                    <label for="payment_deadline" class="form-label">Thời hạn thanh toán bán
                                                        <i class="fas fa-question-circle tooltip-icon" data-bs-toggle="tooltip" title="Số ngày làm việc tối đa để hoàn tất thanh toán cho lệnh bán."></i>
                                                    </label>
                                                    <div class="input-group">
                                                        <input type="number" class="form-control" id="payment_deadline" name="payment_deadline" 
                                                               placeholder="5" required="1"/>
                                                        <span class="input-group-text">ngày</span>
                                                    </div>
                                                    <div class="field-error" id="payment_deadline_error" style="display: none;">
                                                        <i class="fas fa-exclamation-circle"></i>
                                                        <span>Trường này là bắt buộc</span>
                                                    </div>
                                                </div>
                                                
                                                <div class="col-md-6 required-field">
                                                    <label for="redemption_time" class="form-label">Thời gian xử lý hoán đổi
                                                        <i class="fas fa-question-circle tooltip-icon" data-bs-toggle="tooltip" title="Số ngày làm việc để xử lý lệnh chuyển đổi giữa các quỹ."></i>
                                                    </label>
                                                    <div class="input-group">
                                                        <input type="number" class="form-control" id="redemption_time" name="redemption_time" 
                                                               placeholder="3" required="1"/>
                                                        <span class="input-group-text">ngày</span>
                                                    </div>
                                                    <div class="field-error" id="redemption_time_error" style="display: none;">
                                                        <i class="fas fa-exclamation-circle"></i>
                                                        <span>Trường này là bắt buộc</span>
                                                    </div>
                                                </div>
                                                
                                                <div class="col-md-6 required-field">
                                                    <label for="report_website" class="form-label">Website báo cáo
                                                        <i class="fas fa-question-circle tooltip-icon" data-bs-toggle="tooltip" title="Địa chỉ website công bố báo cáo tài chính của quỹ."></i>
                                                    </label>
                                                    <input type="url" class="form-control" id="report_website" name="report_website" 
                                                           placeholder="https://example.com/reports" required="1"/>
                                                    <div class="field-error" id="report_website_error" style="display: none;">
                                                        <i class="fas fa-exclamation-circle"></i>
                                                        <span>Trường này là bắt buộc</span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Step 3: Product Classification -->
                                    <div class="form-step" id="step3">
                                        <div class="form-section">
                                            <div class="section-header">
                                                <div class="section-icon"><i class="fas fa-sitemap fa-lg text-warning"></i></div>
                                                <div>
                                                    <h5 class="mb-1">Phân loại sản phẩm</h5>
                                                    <small class="text-muted">Xác định các thuộc tính của quỹ để phân loại và báo cáo.</small>
                                                </div>
                                            </div>
                                            <!-- REFACTOR: Improved responsive layout for classification fields -->
                                            <div class="row g-4">
                                                <div class="col-xl-6 col-lg-6 col-md-12 required-field">
                                                    <label for="fund_type" class="form-label">Loại quỹ</label>
                                                    <select class="form-select" id="fund_type" name="fund_type" required="1">
                                                        <option value="" selected="1" disabled="1">-- Chọn loại quỹ --</option>
                                                        <t t-foreach="fund_types" t-as="ft">
                                                            <option t-att-value="ft[0]" t-esc="ft[1]"/>
                                                        </t>
                                                    </select>
                                                    <div class="field-error" id="fund_type_error" style="display: none;">
                                                        <i class="fas fa-exclamation-circle"></i>
                                                        <span>Vui lòng chọn loại quỹ</span>
                                                    </div>
                                                </div>
                                                
                                                <div class="col-xl-6 col-lg-6 col-md-12 required-field">
                                                    <label for="risk_level" class="form-label">Mức độ rủi ro</label>
                                                    <select class="form-select" id="risk_level" name="risk_level" required="1">
                                                        <option value="" selected="1" disabled="1">-- Chọn mức độ rủi ro --</option>
                                                        <t t-foreach="risk_levels" t-as="rl">
                                                            <option t-att-value="rl[0]" t-esc="rl[1]"/>
                                                        </t>
                                                    </select>
                                                    <div class="field-error" id="risk_level_error" style="display: none;">
                                                        <i class="fas fa-exclamation-circle"></i>
                                                        <span>Vui lòng chọn mức độ rủi ro</span>
                                                    </div>
                                                </div>
                                                
                                                <div class="col-xl-6 col-lg-6 col-md-12 required-field">
                                                    <label for="product_type" class="form-label">Loại sản phẩm</label>
                                                    <select class="form-select" id="product_type" name="product_type" required="1">
                                                        <option value="" selected="1" disabled="1">-- Chọn loại sản phẩm --</option>
                                                        <t t-foreach="product_types" t-as="pt">
                                                            <option t-att-value="pt[0]" t-esc="pt[1]"/>
                                                        </t>
                                                    </select>
                                                    <div class="field-error" id="product_type_error" style="display: none;">
                                                        <i class="fas fa-exclamation-circle"></i>
                                                        <span>Vui lòng chọn loại sản phẩm</span>
                                                    </div>
                                                </div>
                                                
                                                <div class="col-xl-6 col-lg-6 col-md-12 required-field">
                                                    <label for="product_status" class="form-label">Trạng thái</label>
                                                    <select class="form-select" id="product_status" name="product_status" required="1">
                                                        <option value="" selected="1" disabled="1">-- Chọn trạng thái --</option>
                                                        <t t-foreach="product_statuses" t-as="ps">
                                                            <option t-att-value="ps[0]" t-esc="ps[1]"/>
                                                        </t>
                                                    </select>
                                                    <div class="field-error" id="product_status_error" style="display: none;">
                                                        <i class="fas fa-exclamation-circle"></i>
                                                        <span>Vui lòng chọn trạng thái</span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Step 4: Additional Information -->
                                    <div class="form-step" id="step4">
                                        <div class="form-section">
                                            <div class="section-header">
                                                <div class="section-icon"><i class="fas fa-puzzle-piece fa-lg text-success"></i></div>
                                                <div>
                                                    <h5 class="mb-1">Thông tin bổ sung</h5>
                                                    <small class="text-muted">Mô tả chi tiết, hình ảnh và lịch giao dịch.</small>
                                                </div>
                                            </div>
                                            <div class="row g-4">
                                                <div class="col-lg-7">
                                                    <label for="fund_description" class="form-label">Mô tả chi tiết quỹ</label>
                                                    <textarea class="form-control" id="fund_description" name="fund_description" rows="12" 
                                                              placeholder="Nhập mô tả chi tiết về chiến lược đầu tư, mục tiêu, và các thông tin quan trọng khác của quỹ..."></textarea>
                                                </div>
                                                <div class="col-lg-5">
                                                    <div class="mb-3">
                                                        <label for="fund_image" class="form-label">Hình ảnh đại diện quỹ</label>
                                                        <input class="form-control" type="file" id="fund_image" name="fund_image" accept="image/png, image/jpeg"/>
                                                    </div>
                                                    <div>
                                                        <div class="d-flex justify-content-between align-items-center mb-2">
                                                            <label class="form-label mb-0">Lịch giao dịch trong tuần</label>
                                                            <a href="#" id="selectAllDays" class="small text-decoration-none">Chọn/Bỏ chọn tất cả</a>
                                                        </div>
                                                        <div class="row g-2 trading-days-grid" id="tradingDaysCheckboxes">
                                                            <div class="col-6"><div class="form-check"><input class="form-check-input" type="checkbox" value="1" id="monday" name="monday"/><label class="form-check-label w-100" for="monday">Thứ Hai</label></div></div>
                                                            <div class="col-6"><div class="form-check"><input class="form-check-input" type="checkbox" value="1" id="tuesday" name="tuesday"/><label class="form-check-label w-100" for="tuesday">Thứ Ba</label></div></div>
                                                            <div class="col-6"><div class="form-check"><input class="form-check-input" type="checkbox" value="1" id="wednesday" name="wednesday"/><label class="form-check-label w-100" for="wednesday">Thứ Tư</label></div></div>
                                                            <div class="col-6"><div class="form-check"><input class="form-check-input" type="checkbox" value="1" id="thursday" name="thursday"/><label class="form-check-label w-100" for="thursday">Thứ Năm</label></div></div>
                                                            <div class="col-6"><div class="form-check"><input class="form-check-input" type="checkbox" value="1" id="friday" name="friday"/><label class="form-check-label w-100" for="friday">Thứ Sáu</label></div></div>
                                                            <div class="col-6"><div class="form-check"><input class="form-check-input" type="checkbox" value="1" id="saturday" name="saturday"/><label class="form-check-label w-100" for="saturday">Thứ Bảy</label></div></div>
                                                            <div class="col-6"><div class="form-check"><input class="form-check-input" type="checkbox" value="1" id="sunday" name="sunday"/><label class="form-check-label w-100" for="sunday">Chủ Nhật</label></div></div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- REFACTOR: Step navigation with enhanced UX -->
                                <div class="step-navigation">
                                    <button type="button" class="btn btn-step btn-step-prev" id="prevBtn" style="visibility: hidden;">
                                        <i class="fas fa-chevron-left me-2"></i>Quay lại
                                    </button>
                                    
                                    <div class="step-info text-muted">
                                        <small id="stepInfo">Bước 1 của 4</small>
                                    </div>
                                    
                                    <button type="button" class="btn btn-step btn-step-next" id="nextBtn">
                                        Tiếp theo<i class="fas fa-chevron-right ms-2"></i>
                                    </button>
                                    
                                    <!-- REFACTOR: Enhanced submit button with loading state -->
                                    <button type="submit" class="btn btn-primary-custom" id="submitBtn" style="display: none;">
                                        <span class="spinner-border spinner-border-sm d-none me-2" role="status" id="submitSpinner"></span>
                                        <i class="fas fa-save me-2" id="submitIcon"></i>
                                        <span id="submitText">Lưu Chứng chỉ quỹ</span>
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </main>
            </div>

            <script>
                <![CDATA[ 
                document.addEventListener('DOMContentLoaded', function() {
                    console.log('DOM loaded, initializing enhanced form...');
                    
                    // === SIDEBAR FUNCTIONALITY (unchanged) ===
                    const sidebarContainer = document.getElementById('sidebarContainer');
                    const sidebar = sidebarContainer?.querySelector('.modern-sidebar');
                    const sidebarToggle = document.getElementById('sidebarToggle');
                    const mobileSidebarToggle = document.getElementById('mobileSidebarToggle');
                    const sidebarOverlay = document.getElementById('sidebarOverlay');
                    const toggleIcon = document.getElementById('toggleIcon');

                    // Desktop sidebar toggle
                    if (sidebarToggle && sidebar && toggleIcon) {
                        sidebarToggle.addEventListener('click', function(e) {
                            e.preventDefault();
                            sidebar.classList.toggle('collapsed');
                            
                            if (sidebar.classList.contains('collapsed')) {
                                toggleIcon.classList.remove('fa-chevron-left');
                                toggleIcon.classList.add('fa-chevron-right');
                            } else {
                                toggleIcon.classList.remove('fa-chevron-right');
                                toggleIcon.classList.add('fa-chevron-left');
                            }
                        });
                    }

                    // Mobile sidebar toggle
                    if (mobileSidebarToggle && sidebar && sidebarOverlay) {
                        mobileSidebarToggle.addEventListener('click', function(e) {
                            e.preventDefault();
                            sidebar.classList.add('show');
                            sidebarOverlay.classList.add('show');
                        });
                    }

                    // Close mobile sidebar when clicking overlay
                    if (sidebarOverlay && sidebar) {
                        sidebarOverlay.addEventListener('click', function() {
                            sidebar.classList.remove('show');
                            sidebarOverlay.classList.remove('show');
                        });
                    }

                    // Handle window resize
                    window.addEventListener('resize', function() {
                        if (window.innerWidth > 768 && sidebar && sidebar.classList.contains('show')) {
                            sidebar.classList.remove('show');
                            if (sidebarOverlay) {
                                sidebarOverlay.classList.remove('show');
                            }
                        }
                    });

                    // === ENHANCED FORM FUNCTIONALITY ===
                    
                    // REFACTOR: Multi-step form implementation
                    let currentStep = 1;
                    const totalSteps = 4;
                    const formSteps = document.querySelectorAll('.form-step');
                    const stepNavItems = document.querySelectorAll('.step-nav-item');
                    const progressFill = document.getElementById('progressFill');
                    const currentStepText = document.getElementById('currentStepText');
                    const stepInfo = document.getElementById('stepInfo');
                    const prevBtn = document.getElementById('prevBtn');
                    const nextBtn = document.getElementById('nextBtn');
                    const submitBtn = document.getElementById('submitBtn');

                    // REFACTOR: Initialize Bootstrap Tooltips with better configuration
                    const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
                    tooltipTriggerList.map(function (tooltipTriggerEl) { 
                        return new bootstrap.Tooltip(tooltipTriggerEl, {
                            delay: { show: 300, hide: 100 }
                        }); 
                    });

                    // REFACTOR: Step navigation functionality
                    function updateStepDisplay() {
                        // Hide all steps
                        formSteps.forEach(step => {
                            step.classList.remove('active');
                        });

                        // Show current step
                        const activeStep = document.getElementById(`step${currentStep}`);
                        if (activeStep) {
                            activeStep.classList.add('active');
                        }

                        // Update progress bar
                        const progressPercent = (currentStep / totalSteps) * 100;
                        progressFill.style.width = `${progressPercent}%`;

                        // Update step navigation pills
                        stepNavItems.forEach((item, index) => {
                            item.classList.remove('active', 'completed');
                            if (index + 1 === currentStep) {
                                item.classList.add('active');
                            } else if (index + 1 < currentStep) {
                                item.classList.add('completed');
                            }
                        });

                        // Update text indicators
                        currentStepText.textContent = `Bước ${currentStep}/${totalSteps}`;
                        stepInfo.textContent = `Bước ${currentStep} của ${totalSteps}`;

                        // Update button visibility
                        prevBtn.style.visibility = currentStep === 1 ? 'hidden' : 'visible';
                        
                        if (currentStep === totalSteps) {
                            nextBtn.style.display = 'none';
                            submitBtn.style.display = 'block';
                        } else {
                            nextBtn.style.display = 'block';
                            submitBtn.style.display = 'none';
                        }
                    }

                    // REFACTOR: Step navigation event handlers
                    prevBtn.addEventListener('click', function() {
                        if (currentStep > 1) {
                            currentStep--;
                            updateStepDisplay();
                        }
                    });

                    nextBtn.addEventListener('click', function() {
                        if (validateCurrentStep() && currentStep < totalSteps) {
                            currentStep++;
                            updateStepDisplay();
                        }
                    });

                    // Allow clicking on step nav items to jump to steps
                    stepNavItems.forEach((item, index) => {
                        item.addEventListener('click', function() {
                            const targetStep = index + 1;
                            if (targetStep <= currentStep || validateStepsUpTo(targetStep - 1)) {
                                currentStep = targetStep;
                                updateStepDisplay();
                            }
                        });
                    });

                    // REFACTOR: Real-time validation implementation
                    function showFieldError(fieldId, message) {
                        const field = document.getElementById(fieldId);
                        const errorDiv = document.getElementById(`${fieldId}_error`);
                        
                        if (field && errorDiv) {
                            field.classList.add('is-invalid');
                            field.classList.remove('is-valid');
                            errorDiv.style.display = 'flex';
                            errorDiv.querySelector('span').textContent = message;
                        }
                    }

                    function showFieldSuccess(fieldId) {
                        const field = document.getElementById(fieldId);
                        const errorDiv = document.getElementById(`${fieldId}_error`);
                        
                        if (field && errorDiv) {
                            field.classList.remove('is-invalid');
                            field.classList.add('is-valid');
                            errorDiv.style.display = 'none';
                        }
                    }

                    function validateField(fieldId, customValidation = null) {
                        const field = document.getElementById(fieldId);
                        if (!field) return true;

                        const value = field.value.trim();
                        const isRequired = field.hasAttribute('required');

                        // Check if required field is empty
                        if (isRequired && value === '') {
                            showFieldError(fieldId, 'Trường này là bắt buộc');
                            return false;
                        }

                        // Custom validation
                        if (customValidation && value !== '') {
                            const customResult = customValidation(value);
                            if (customResult !== true) {
                                showFieldError(fieldId, customResult);
                                return false;
                            }
                        }

                        // HTML5 validation
                        if (value !== '' && !field.checkValidity()) {
                            showFieldError(fieldId, 'Định dạng không hợp lệ');
                            return false;
                        }

                        if (value !== '' || !isRequired) {
                            showFieldSuccess(fieldId);
                        }
                        return true;
                    }

                    // REFACTOR: Enhanced field validation with real-time feedback
                    const requiredFields = document.querySelectorAll('.required-field .form-control, .required-field .form-select');
                    requiredFields.forEach(field => {
                        // Validate on blur
                        field.addEventListener('blur', function() {
                            validateField(this.id);
                        });

                        // Clear error on input for text fields
                        if (field.type === 'text' || field.type === 'number' || field.type === 'url' || field.tagName === 'TEXTAREA') {
                            field.addEventListener('input', function() {
                                if (this.value.trim() !== '' && this.classList.contains('is-invalid')) {
                                    validateField(this.id);
                                }
                            });
                        }

                        // Validate on change for select fields
                        if (field.tagName === 'SELECT') {
                            field.addEventListener('change', function() {
                                validateField(this.id);
                            });
                        }
                    });

                    // REFACTOR: Step validation functions
                    function validateCurrentStep() {
                        const currentStepElement = document.getElementById(`step${currentStep}`);
                        if (!currentStepElement) return true;

                        const stepFields = currentStepElement.querySelectorAll('.required-field .form-control, .required-field .form-select');
                        let isValid = true;

                        stepFields.forEach(field => {
                            if (!validateField(field.id)) {
                                isValid = false;
                            }
                        });

                        if (!isValid) {
                            // Scroll to first error field
                            const firstError = currentStepElement.querySelector('.is-invalid');
                            if (firstError) {
                                firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
                                firstError.focus();
                            }
                        }

                        return isValid;
                    }

                    function validateStepsUpTo(stepNumber) {
                        for (let i = 1; i <= stepNumber; i++) {
                            const stepElement = document.getElementById(`step${i}`);
                            if (!stepElement) continue;

                            const stepFields = stepElement.querySelectorAll('.required-field .form-control, .required-field .form-select');
                            for (let field of stepFields) {
                                if (!validateField(field.id)) {
                                    return false;
                                }
                            }
                        }
                        return true;
                    }

                    // REFACTOR: Auto-save functionality
                    let autoSaveTimer;
                    const autoSaveStatus = document.getElementById('autoSaveStatus');
                    const autoSaveText = document.getElementById('autoSaveText');

                    function showAutoSaveStatus(message, isError = false) {
                        autoSaveText.textContent = message;
                        autoSaveStatus.className = `auto-save-status show ${isError ? 'bg-danger' : ''}`;
                        
                        setTimeout(() => {
                            autoSaveStatus.classList.remove('show');
                        }, 2000);
                    }

                    function autoSave() {
                        const form = document.getElementById('fundCertificateForm');
                        const formData = new FormData(form);
                        
                        // Add draft flag
                        formData.append('is_draft', '1');
                        
                        fetch('/fund_certificate/save_draft', {
                            method: 'POST',
                            body: formData
                        }).then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                showAutoSaveStatus('Đã lưu tự động');
                            }
                        }).catch(error => {
                            console.error('Auto-save failed:', error);
                            showAutoSaveStatus('Lỗi lưu tự động', true);
                        });
                    }

                    // Set up auto-save
                    document.addEventListener('input', function(e) {
                        if (e.target.matches('input, select, textarea')) {
                            clearTimeout(autoSaveTimer);
                            autoSaveTimer = setTimeout(autoSave, 30000); // 30s delay
                        }
                    });

                    // REFACTOR: Enhanced form submission with loading state
                    const form = document.getElementById('fundCertificateForm');
                    if (form) {
                        form.addEventListener('submit', function (event) {
                            event.preventDefault();
                            
                            // Validate all steps
                            if (!validateStepsUpTo(totalSteps)) {
                                // Find first invalid step and navigate to it
                                for (let i = 1; i <= totalSteps; i++) {
                                    const stepElement = document.getElementById(`step${i}`);
                                    const hasError = stepElement.querySelector('.is-invalid');
                                    if (hasError) {
                                        currentStep = i;
                                        updateStepDisplay();
                                        hasError.scrollIntoView({ behavior: 'smooth', block: 'center' });
                                        hasError.focus();
                                        break;
                                    }
                                }
                                return;
                            }

                            // Show loading state
                            const submitSpinner = document.getElementById('submitSpinner');
                            const submitIcon = document.getElementById('submitIcon');
                            const submitTextEl = document.getElementById('submitText');
                            
                            submitBtn.disabled = true;
                            submitSpinner.classList.remove('d-none');
                            submitIcon.classList.add('d-none');
                            submitTextEl.textContent = 'Đang lưu...';

                            // Submit form
                            this.submit();
                        });
                    }
                    
                    // REFACTOR: Trading Days Checkbox Functionality (unchanged)
                    const selectAllLink = document.getElementById('selectAllDays');
                    const checkboxes = document.querySelectorAll('#tradingDaysCheckboxes .form-check-input');
                    if (selectAllLink) {
                        selectAllLink.addEventListener('click', function(e) {
                            e.preventDefault();
                            const anyUnchecked = Array.from(checkboxes).some(cb => !cb.checked);
                            checkboxes.forEach(cb => cb.checked = anyUnchecked);
                        });
                    }

                    // REFACTOR: Smart field dependencies - Auto-generate English name
                    const fullNameField = document.getElementById('full_name');
                    const englishNameField = document.getElementById('english_name');
                    
                    if (fullNameField && englishNameField) {
                        fullNameField.addEventListener('input', function() {
                            if (englishNameField.value === '' && this.value.trim() !== '') {
                                // Simple transliteration (basic implementation)
                                const transliterated = transliterate(this.value);
                                englishNameField.value = transliterated;
                            }
                        });
                    }

                    function transliterate(text) {
                        // Basic Vietnamese to English transliteration
                        const vnMap = {
                            'à|á|ạ|ả|ã|â|ầ|ấ|ậ|ẩ|ẫ|ă|ằ|ắ|ặ|ẳ|ẵ': 'a',
                            'è|é|ẹ|ẻ|ẽ|ê|ề|ế|ệ|ể|ễ': 'e',
                            'ì|í|ị|ỉ|ĩ': 'i',
                            'ò|ó|ọ|ỏ|õ|ô|ồ|ố|ộ|ổ|ỗ|ơ|ờ|ớ|ợ|ở|ỡ': 'o',
                            'ù|ú|ụ|ủ|ũ|ư|ừ|ứ|ự|ử|ữ': 'u',
                            'ỳ|ý|ỵ|ỷ|ỹ': 'y',
                            'đ': 'd',
                            'Đ': 'D',
                        };

                        let result = text;
                        for (const [vietnamese, english] of Object.entries(vnMap)) {
                            result = result.replace(new RegExp(vietnamese, 'gi'), english);
                        }
                        return result;
                    }

                    // Initialize the form
                    updateStepDisplay();
                    
                    console.log('Enhanced multi-step form initialized successfully');
                });
                ]]>
            </script>
        </t>
    </template>
</odoo>
