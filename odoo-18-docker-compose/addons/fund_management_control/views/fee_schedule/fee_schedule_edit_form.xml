<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <template id="fund_management_control.fee_schedule_edit_form" name="Chỉnh sửa Biểu phí">
        <t t-call="web.layout">
            <t t-set="title">Chỉnh sửa Biểu phí</t>
            <t t-call-assets="web.assets_backend" t-js="true"/>

            <t t-set="head">
                <!-- Dependencies -->
                <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
                <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
                <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet"/>
                
                <!-- Reusing the same styles from the create form for consistency -->
                <style>
                    /* General and Layout Styles */
                    body {
                        background-color: #f8f9fa;
                        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                        margin: 0;
                        padding: 0;
                    }
                    .app-container {
                        display: flex;
                        min-height: 100vh;
                        position: relative;
                    }
                    .sidebar-container {
                        position: sticky;
                        top: 0;
                        height: 100vh;
                        z-index: 1000;
                    }
                    .sidebar-toggle {
                        position: absolute; top: 15px; right: -15px; background: #fff;
                        border: 2px solid #667eea; border-radius: 50%; width: 30px; height: 30px;
                        display: flex; align-items: center; justify-content: center; cursor: pointer;
                        box-shadow: 0 2px 8px rgba(0,0,0,0.15); z-index: 1001; transition: all 0.3s ease;
                    }
                    .sidebar-toggle:hover {
                        background: #667eea;
                        color: #fff !important;
                        transform: scale(1.1);
                    }
                    .main-content {
                        flex: 1;
                        min-height: 100vh;
                        overflow-x: auto;
                    }

                    /* Mobile Responsive Layout */
                    @media (max-width: 768px) {
                        .sidebar-container { position: fixed; z-index: 1050; }
                        .sidebar-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1040; display: none; opacity: 0; transition: opacity 0.3s ease; }
                        .sidebar-overlay.show { display: block; opacity: 1; }
                        .mobile-header { display: flex !important; }
                        .sidebar-toggle { display: none !important; }
                    }
                    @media (min-width: 769px) { .mobile-header { display: none !important; } }

                    /* Form Specific Styles */
                    .form-main-container { max-width: 900px; margin: 2rem auto; padding: 0 1rem; }
                    .form-card { background: white; border-radius: 1rem; box-shadow: 0 8px 25px rgba(0,0,0,0.1); overflow: hidden; margin-bottom: 2rem; }
                    .card-header-custom { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 2rem; text-align: center; }
                    .form-section { padding: 2rem; border-bottom: 1px solid #f0f0f0; }
                    .form-section:last-child { border-bottom: none; }
                    .section-header { display: flex; align-items: center; margin-bottom: 1.5rem; color: #2c3e50; }
                    .section-icon { width: 45px; height: 45px; border-radius: 12px; background: linear-gradient(135deg, #667eea20 0%, #764ba220 100%); display: flex; align-items: center; justify-content: center; margin-right: 1rem; }
                    .form-control, .form-select { border: 2px solid #e9ecef; border-radius: 0.75rem; padding: 0.875rem 1rem; font-size: 0.95rem; transition: all 0.3s ease; }
                    .form-control:focus, .form-select:focus { border-color: #667eea; box-shadow: 0 0 0 0.25rem rgba(102, 126, 234, 0.15); }
                    .toggle-switch-card { background: #f8f9fa; border-radius: 1rem; padding: 1.5rem; text-align: center; transition: all 0.3s ease; cursor: pointer; border: 2px solid transparent; height: 100%; display: flex; flex-direction: column; justify-content: center; align-items: center; }
                    .toggle-switch-card:hover { background: #e9eafc; border-color: #667eea; transform: translateY(-2px); }
                    .toggle-switch-card.active { background: linear-gradient(135deg, #667eea10 0%, #764ba210 100%); border-color: #667eea; }
                    .custom-switch { width: 50px; height: 28px; background: #dee2e6; border-radius: 14px; position: relative; display: inline-block; cursor: pointer; transition: all 0.3s ease; }
                    .custom-switch.active { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
                    .switch-handle { width: 22px; height: 22px; background: white; border-radius: 50%; position: absolute; top: 3px; left: 3px; transition: all 0.3s ease; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
                    .custom-switch.active .switch-handle { transform: translateX(22px); }
                    .btn-primary-custom { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none; border-radius: 0.75rem; padding: 0.875rem 2rem; font-weight: 600; transition: all 0.3s ease; }
                    .btn-secondary-custom { background: #f8f9fa; border: 2px solid #dee2e6; border-radius: 0.75rem; padding: 0.875rem 2rem; font-weight: 600; color: #495057; transition: all 0.3s ease; }
                </style>
            </t>

            <div class="app-container">
                <!-- Sidebar -->
                <div class="sidebar-container" id="sidebarContainer">
                    <div class="sidebar-toggle d-none d-lg-flex" id="sidebarToggle">
                        <i class="fas fa-chevron-left text-primary" id="toggleIcon"></i>
                    </div>
                    <t t-call="fund_management_control.sidebar_template"/>
                </div>

                <!-- Main Content -->
                <main class="main-content">
                    <div class="form-main-container">
                        <div class="form-card">
                            <div class="card-header-custom">
                                <h2 class="mb-2 h3"><i class="fas fa-edit me-2"></i>Chỉnh sửa Biểu phí</h2>
                                <p class="mb-0 opacity-90">Cập nhật thông tin chi tiết cho biểu phí.</p>
                            </div>

                            <form action="/fee_schedule/update" method="POST" id="feeScheduleEditForm" novalidate="1">
                                <input type="hidden" name="csrf_token" t-att-value="request.csrf_token()"/>
                                <!-- Add hidden input for the record ID -->
                                <input type="hidden" name="fee_id" t-att-value="fee.id"/>
                                
                                <div class="form-section">
                                    <div class="section-header">
                                        <div class="section-icon"><i class="fas fa-info-circle fa-lg text-primary"></i></div>
                                        <div><h5 class="mb-1">Thông tin cơ bản</h5><small class="text-muted">Các thông tin định danh chính của biểu phí.</small></div>
                                    </div>
                                    <div class="row g-3">
                                        <div class="col-md-6"><label for="fee_name" class="form-label fw-semibold">Tên loại phí <span class="text-danger">*</span></label><input type="text" class="form-control" id="fee_name" name="fee_name" required="1" t-att-value="fee.fee_name"/></div>
                                        <div class="col-md-6"><label for="fee_code" class="form-label fw-semibold">Mã phí VSD <span class="text-danger">*</span></label><input type="text" class="form-control" id="fee_code" name="fee_code" required="1" t-att-value="fee.fee_code"/></div>
                                        <div class="col-md-6"><label for="fee_type" class="form-label fw-semibold">Loại phí</label><select class="form-select" id="fee_type" name="fee_type"><t t-foreach="fee_types" t-as="ft"><option t-att-value="ft[0]" t-esc="ft[1]" t-att-selected="fee.fee_type == ft[0]"/></t></select></div>
                                        <div class="col-md-6"><label for="scheme_id" class="form-label fw-semibold">Áp dụng cho chương trình</label><select class="form-select" id="scheme_id" name="scheme_id"><option value="">-- Áp dụng cho tất cả --</option><t t-foreach="schemes" t-as="s"><option t-att-value="s.id" t-esc="s.name" t-att-selected="fee.scheme_id.id == s.id"/></t></select></div>
                                    </div>
                                </div>

                                <div class="form-section">
                                    <div class="section-header"><div class="section-icon"><i class="fas fa-filter fa-lg text-info"></i></div><div><h5 class="mb-1">Điều kiện áp dụng</h5><small class="text-muted">Thiết lập khoảng giá trị để tính phí.</small></div></div>
                                    <div class="row g-3 align-items-center">
                                        <div class="col-md-6 col-lg-3"><label class="form-label fw-semibold">Toán tử 1</label><select class="form-select" name="operator_1"><t t-foreach="operators" t-as="op"><option t-att-value="op[0]" t-esc="op[1]" t-att-selected="fee.operator_1 == op[0]"/></t></select></div>
                                        <div class="col-md-6 col-lg-3"><label class="form-label fw-semibold">Giá trị ban đầu <span class="text-danger">*</span></label><input type="number" class="form-control" name="initial_value" placeholder="0" required="1" t-att-value="fee.initial_value"/></div>
                                        <div class="col-md-6 col-lg-3"><label class="form-label fw-semibold">Toán tử 2</label><select class="form-select" name="operator_2"><t t-foreach="operators" t-as="op"><option t-att-value="op[0]" t-esc="op[1]" t-att-selected="fee.operator_2 == op[0]"/></t></select></div>
                                        <div class="col-md-6 col-lg-3"><label class="form-label fw-semibold">Giá trị kết thúc <span class="text-danger">*</span></label><input type="text" class="form-control" name="end_value" placeholder="1000000 hoặc NAV" required="1" t-att-value="fee.end_value"/></div>
                                    </div>
                                </div>
                                
                                <div class="form-section">
                                    <div class="section-header"><div class="section-icon"><i class="fas fa-cogs fa-lg text-success"></i></div><div><h5 class="mb-1">Cấu hình &amp; Trạng thái</h5><small class="text-muted">Thiết lập tỉ lệ phí và kích hoạt.</small></div></div>
                                    <div class="row g-3">
                                        <div class="col-md-6"><label for="fee_rate" class="form-label fw-semibold">Tỉ lệ phí <span class="text-danger">*</span></label><div class="input-group"><input type="number" step="0.01" class="form-control" id="fee_rate" name="fee_rate" placeholder="1.5" required="1" t-att-value="fee.fee_rate"/><span class="input-group-text">%</span></div></div>
                                        <div class="col-md-6">
                                            <label class="form-label fw-semibold d-block mb-2">Trạng thái</label>
                                            <div t-attf-class="toggle-switch-card #{'active' if fee.activate else ''}" onclick="toggleSwitchCard(this)">
                                                <input type="checkbox" class="d-none" name="activate" value="on" t-att-checked="fee.activate"/>
                                                <div t-attf-class="custom-switch mb-2 #{'active' if fee.activate else ''}"><div class="switch-handle"></div></div>
                                                <h6 class="fw-bold mb-0">Kích hoạt biểu phí</h6>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="form-section">
                                    <div class="d-flex flex-column flex-sm-row gap-3 justify-content-center">
                                        <a href="/fee_schedule_list" class="btn btn-secondary-custom d-flex align-items-center justify-content-center"><i class="fas fa-times me-2"></i>Hủy bỏ</a>
                                        <button type="submit" class="btn btn-primary-custom d-flex align-items-center justify-content-center"><i class="fas fa-save me-2"></i>Cập nhật</button>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                </main>
            </div>

            <script>
                <![CDATA[ 
                // Script for sidebar and form validation, same as create form
                document.addEventListener('DOMContentLoaded', function() {
                    const sidebarContainer = document.getElementById('sidebarContainer');
                    const sidebar = sidebarContainer?.querySelector('.modern-sidebar');
                    const sidebarToggle = document.getElementById('sidebarToggle');
                    const toggleIcon = document.getElementById('toggleIcon');

                    if (sidebarToggle && sidebar && toggleIcon) {
                        sidebarToggle.addEventListener('click', function(e) {
                            e.preventDefault();
                            sidebar.classList.toggle('collapsed');
                            const isCollapsed = sidebar.classList.contains('collapsed');
                            toggleIcon.classList.toggle('fa-chevron-left', !isCollapsed);
                            toggleIcon.classList.toggle('fa-chevron-right', isCollapsed);
                        });
                    }

                    const form = document.getElementById('feeScheduleEditForm');
                    if(form) {
                        form.addEventListener('submit', function (event) {
                            if (!form.checkValidity()) {
                                event.preventDefault();
                                event.stopPropagation();
                            }
                            form.classList.add('was-validated');
                        }, false);
                    }
                });

                function toggleSwitchCard(cardElement) {
                    const hiddenCheckbox = cardElement.querySelector('input[type="checkbox"]');
                    const customSwitch = cardElement.querySelector('.custom-switch');
                    const isActive = cardElement.classList.toggle('active');
                    customSwitch.classList.toggle('active', isActive);
                    hiddenCheckbox.checked = isActive;
                }
                ]]>
            </script>
        </t>
    </template>
</odoo>
